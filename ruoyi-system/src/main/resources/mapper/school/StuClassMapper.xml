<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.school.mapper.StuClassMapper">

    <resultMap type="StuClass" id="StuClassResult">
        <result property="classId"    column="class_id"    />
        <result property="semester"    column="semester"    />
        <result property="courseId"    column="course_id"    />
        <result property="courseName"  column="course_name"  /> <!-- 新增关联字段 -->
        <result property="staffId"    column="staff_id"    />
        <result property="dayOfWeek"    column="day_of_week"    />
        <result property="lessonStart"    column="lesson_start"    />
        <result property="lessonEnd"    column="lesson_end"    />
        <result property="weekStart"    column="week_start"    />
        <result property="weekEnd"    column="week_end"    />
        <result property="weekType"    column="week_type"    />
        <result property="classroomId"    column="classroom_id"    />
        <result property="capacity"    column="capacity"    />
        <result property="selectedNum"    column="selected_num"    />
        <result property="staffName"    column="staff_name"    />
    </resultMap>

    <!-- 基础查询：关联课程表获取课程名字 -->

    <sql id="selectStuClassVo">
        select c.class_id, c.semester, c.course_id, c.class_section, c.staff_id,
               c.day_of_week, c.lesson_start, c.lesson_end, c.week_start, c.week_end,
               c.week_type, c.classroom_id, c.capacity, c.selected_num,
               co.course_name,
               u.nick_name as staff_name
        from stu_class c
                 left join stu_course co on c.course_id = co.course_id
                 left join sys_user u on c.staff_id = u.user_name
    </sql>



    <!-- 列表查询：修正了字段引用 -->
    <select id="selectStuClassList" parameterType="StuClass" resultMap="StuClassResult">
        <include refid="selectStuClassVo"/>
        <where>
            <if test="courseId != null  and courseId != ''"> and c.course_id = #{courseId}</if>
            <if test="staffId != null  and staffId != ''"> and c.staff_id = #{staffId}</if>
        </where>
    </select>

    <!-- 批量删除 -->
    <delete id="deleteStuClassByClassIds" parameterType="Long">
        delete from stu_class where class_id in
        <foreach item="classId" collection="array" open="(" separator="," close=")">#{classId}</foreach>
    </delete>

    <!-- 其余 insert/update/plusSelectedNum 等保持原样，但记得在 insert/update 时不操作 course_name 字段 -->
    <insert id="insertStuClass" parameterType="StuClass" useGeneratedKeys="true" keyProperty="classId">
        insert into stu_class
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="semester != null">semester,</if>
            <if test="courseId != null">course_id,</if>
            <if test="staffId != null">staff_id,</if>
            <if test="dayOfWeek != null">day_of_week,</if>
            <if test="lessonStart != null">lesson_start,</if>
            <if test="lessonEnd != null">lesson_end,</if>
            <if test="weekStart != null">week_start,</if>
            <if test="weekEnd != null">week_end,</if>
            <if test="classroomId != null">classroom_id,</if>
            <if test="capacity != null">capacity,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="semester != null">#{semester},</if>
            <if test="courseId != null">#{courseId},</if>
            <if test="staffId != null">#{staffId},</if>
            <if test="dayOfWeek != null">#{dayOfWeek},</if>
            <if test="lessonStart != null">#{lessonStart},</if>
            <if test="lessonEnd != null">#{lessonEnd},</if>
            <if test="weekStart != null">#{weekStart},</if>
            <if test="weekEnd != null">#{weekEnd},</if>
            <if test="classroomId != null">#{classroomId},</if>
            <if test="capacity != null">#{capacity},</if>
        </trim>
    </insert>

    <select id="selectAllCourseOptions" resultType="map">
        select
            course_id as courseId,
            course_name as courseName,
            credit as credit
        from stu_course
    </select>


    <!-- 关键修复：数字化排课冲突检查 -->
    <!-- 逻辑：判断 同一个教室 OR 同一个老师 在 同一时间(周/日/节) 是否有重叠 -->
    <select id="checkSchedulingConflict" parameterType="StuClass" resultType="int">
        select count(*) from stu_class
        <where>
            <!-- 1. 必须是同一个星期几 -->
            and day_of_week = #{dayOfWeek}

            <!-- 2. 判定节次是否有重叠：(开始A <= 结束B) AND (结束A >= 开始B) -->
            and lesson_start &lt;= #{lessonEnd}
            and lesson_end &gt;= #{lessonStart}

            <!-- 3. 判定周次是否有重叠 -->
            and week_start &lt;= #{weekEnd}
            and week_end &gt;= #{weekStart}

            <!-- 4. 判定单双周是否冲突：有一方是每周(0)，或者两方类型相同 -->
            and (week_type = 0 or #{weekType} = 0 or week_type = #{weekType})

            <!-- 5. 判定资源占用：同一个教室 OR 同一个老师 -->
            and (classroom_id = #{classroomId} or staff_id = #{staffId})

            <!-- 6. 如果是修改操作，排除掉正在修改的这一条记录自己 -->
            <if test="classId != null"> and class_id != #{classId} </if>
        </where>
    </select>

</mapper>