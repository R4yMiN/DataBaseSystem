<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.school.mapper.StuClassMapper">

    <resultMap type="StuClass" id="StuClassResult">
        <result property="classId"    column="class_id"    />
        <result property="semester"    column="semester"    />
        <result property="courseId"    column="course_id"    />
        <result property="staffId"    column="staff_id"    />
        <result property="dayOfWeek"    column="day_of_week"    />
        <result property="lessonStart"    column="lesson_start"    />
        <result property="lessonEnd"    column="lesson_end"    />
        <result property="weekStart"    column="week_start"    />
        <result property="weekEnd"    column="week_end"    />
        <result property="weekType"    column="week_type"    />
        <result property="classroomId"    column="classroom_id"    />
        <result property="capacity"    column="capacity"    />
        <result property="selectedNum"    column="selected_num"    />
    </resultMap>

    <sql id="selectStuClassVo">
        select class_id, semester, course_id, staff_id, day_of_week, lesson_start, lesson_end, week_start, week_end, week_type, classroom_id, capacity, selected_num from stu_class
    </sql>

    <!-- 核心：排课冲突检查 -->
    <select id="checkSchedulingConflict" parameterType="StuClass" resultType="int">
        select count(*) from stu_class
        <where>
            and day_of_week = #{dayOfWeek}
            and lesson_start &lt;= #{lessonEnd}
            and lesson_end &gt;= #{lessonStart}
            and week_start &lt;= #{weekEnd}
            and week_end &gt;= #{weekStart}
            and (week_type = 0 or #{weekType} = 0 or week_type = #{weekType})
            and (classroom_id = #{classroomId} or staff_id = #{staffId})
            <if test="classId != null"> and class_id != #{classId} </if>
        </where>
    </select>

    <select id="selectStuClassList" parameterType="StuClass" resultMap="StuClassResult">
        <include refid="selectStuClassVo"/>
        <where>
            <if test="courseId != null  and courseId != ''"> and course_id like concat('%', #{courseId}, '%')</if>
            <if test="dayOfWeek != null "> and day_of_week = #{dayOfWeek}</if>
            <if test="classroomId != null  and classroom_id != ''"> and classroom_id = #{classroomId}</if>
        </where>
    </select>

    <select id="selectStuClassByClassId" parameterType="Long" resultMap="StuClassResult">
        <include refid="selectStuClassVo"/>
        where class_id = #{classId}
    </select>

    <insert id="insertStuClass" parameterType="StuClass" useGeneratedKeys="true" keyProperty="classId">
        insert into stu_class
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="semester != null">semester,</if>
            <if test="courseId != null">course_id,</if>
            <if test="staffId != null">staff_id,</if>
            <if test="dayOfWeek != null">day_of_week,</if>
            <if test="lessonStart != null">lesson_start,</if>
            <if test="lessonEnd != null">lesson_end,</if>
            <if test="weekStart != null">week_start,</if>
            <if test="weekEnd != null">week_end,</if>
            <if test="weekType != null">week_type,</if>
            <if test="classroomId != null">classroom_id,</if>
            <if test="capacity != null">capacity,</if>
            <if test="selectedNum != null">selected_num,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="semester != null">#{semester},</if>
            <if test="courseId != null">#{courseId},</if>
            <if test="staffId != null">#{staffId},</if>
            <if test="dayOfWeek != null">#{dayOfWeek},</if>
            <if test="lessonStart != null">#{lessonStart},</if>
            <if test="lessonEnd != null">#{lessonEnd},</if>
            <if test="weekStart != null">#{weekStart},</if>
            <if test="weekEnd != null">#{weekEnd},</if>
            <if test="weekType != null">#{weekType},</if>
            <if test="classroomId != null">#{classroomId},</if>
            <if test="capacity != null">#{capacity},</if>
            <if test="selectedNum != null">#{selectedNum},</if>
        </trim>
    </insert>

    <update id="updateStuClass" parameterType="StuClass">
        update stu_class
        <set>
            <if test="dayOfWeek != null">day_of_week = #{dayOfWeek},</if>
            <if test="lessonStart != null">lesson_start = #{lessonStart},</if>
            <if test="lessonEnd != null">lesson_end = #{lessonEnd},</if>
            <if test="weekStart != null">week_start = #{weekStart},</if>
            <if test="weekEnd != null">week_end = #{weekEnd},</if>
            <if test="weekType != null">week_type = #{weekType},</if>
            <if test="classroomId != null">classroom_id = #{classroomId},</if>
            <if test="capacity != null">capacity = #{capacity},</if>
            <if test="selectedNum != null">selected_num = #{selectedNum},</if>
        </set>
        where class_id = #{classId}
    </update>

    <!-- 增加已选人数的方法 -->
    <update id="plusSelectedNum">
        update stu_class set selected_num = selected_num + 1 where class_id = #{classId}
    </update>

    <update id="minusSelectedNum">
        update stu_class set selected_num = selected_num - 1 where class_id = #{classId}
    </update>

    <!-- 随机抽签存储过程调用 -->
    <select id="executeRandomKick" statementType="CALLABLE">
        {call proc_random_kick_students()}
    </select>


    <select id="selectAllCourseOptions" resultType="map">
        select course_id as courseId, course_name as courseName, credit
        from stu_course
    </select>
</mapper>